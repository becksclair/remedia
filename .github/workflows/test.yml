name: "Test"

on:
    push:
        branches: [main, develop]
    pull_request:
        branches: [main]

jobs:
    test:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install system dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                      libwebkit2gtk-4.1-dev \
                      build-essential \
                      libgtk-3-dev \
                      libayatana-appindicator3-dev \
                      librsvg2-dev \
                      libssl-dev \
                      pkg-config \
                      patchelf \
                      xdg-utils

            - name: Rust setup
              uses: dtolnay/rust-toolchain@stable

            - name: Rust cache
              uses: swatinem/rust-cache@v2
              with:
                  workspaces: "./src-tauri -> target"

            - name: Install Bun
              uses: oven-sh/setup-bun@v2
              with:
                  bun-version: latest

            - name: Install frontend dependencies
              run: bun install

            - name: Run frontend tests
              run: bun run test

            - name: Run backend tests
              run: cargo test --manifest-path src-tauri/Cargo.toml

            - name: Run linting
              run: bun run lint

            - name: Check formatting
              run: bun run fmt:check

            - name: Build check
              run: bun run build
